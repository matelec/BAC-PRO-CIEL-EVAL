{% extends "base.html" %}

{% block title %}Validation - {{ utilisateur.prenom }} {{ utilisateur.nom }}{% endblock %}

{% block page_scripts %}
<script src="{{ url_for('static', filename='validation.js') }}"></script>
{% endblock %}

{% block content %}
<div class="validation-page">
    <!-- Bouton de retour -->
    <div class="page-header">
        <div class="header-left">
            <a href="{{ url_for('detail_evaluation', evaluation_id=evaluation.id) }}" class="btn-secondary">
                <i class="fas fa-arrow-left"></i> Retour √† l'√©valuation
            </a>
        </div>
        <div class="header-center">
            <h1>Validation des comp√©tences</h1>
        </div>
        <div class="header-right">
            <!-- Vous pouvez ajouter d'autres √©l√©ments ici si besoin -->
        </div>
    </div>
    <div class="validation-header">
        <h2>{{ evaluation.module }}</h2>
        <strong>√âl√®ve:</strong> {{ utilisateur.prenom }} {{ utilisateur.nom }} ({{ utilisateur.classe }})
        <p><strong>Date:</strong> {{ evaluation.date_evaluation | datetimeformat('%d %B %Y') or 'Non d√©finie' }}
    </div>

    <!-- Section Items √† valider -->
    <div class="section-card">
        <div class="card-header">
            <h2><i class="fas fa-tasks"></i> Items √† valider ({{ items|length }})</h2>
            <button class="btn-primary" id="saveAllValidations">
                <i class="fas fa-save"></i> Enregistrer toutes les validations
            </button>
        </div>
        <div class="card-body">
            {% if items %}
            <form id="globalValidationForm">
                <input type="hidden" name="utilisateur_id" value="{{ utilisateur.id }}">
                <input type="hidden" name="evaluation_id" value="{{ evaluation.id }}">
                
                <div class="validation-items">
                    {% for item in items %}
                    {% set validation = validations|selectattr('item_id', 'equalto', item.id)|first %}
                    <div class="validation-item" data-item-id="{{ item.id }}">
                        <table class="validation-table">
                            <tr>
                                <!-- Colonne 1 : Comp√©tence et Statut -->
                                <td class="competence-cell">
                                    <div class="competence-info">
                                        <span class="competence-badge">{{ item.competence_code }}</span>
                                        <h3 class="item-title">{{ item.code_item }}</h3>
                                        {% if item.description %}
                                        <p class="item-description">{{ item.description }}</p>
                                        {% endif %}
                                        
                                        <!-- Badge de statut global -->
                                        <div class="validation-status">
                                            {% if validation %}
                                            <span class="status-badge status-{{ validation.niveau_validation }}">
                                                {% if validation.niveau_validation == 1 %}üü• Non Acquis
                                                {% elif validation.niveau_validation == 2 %}üüß En Cours
                                                {% elif validation.niveau_validation == 3 %}üü© Acquis
                                                {% elif validation.niveau_validation == 4 %}‚úÖ Expert
                                                {% endif %}
                                            </span>
                                            {% else %}
                                            <span class="status-badge status-0">‚è≥ Non valid√©</span>
                                            {% endif %}
                                        </div>
                                    </div>
                                </td>
                                
                                <!-- Colonne 2 : Sous-item et Actions -->
                                <td class="actions-cell">
                                    <div class="sub-item-content">
                                        {% if item.sous_item %}
                                        <div class="sub-item-header">
                                            <h4>Sous-item √† valider :</h4>
                                            <p class="sub-item-text">{{ item.sous_item }}</p>
                                        </div>
                                        {% endif %}
                                        
                                        <!-- Boutons de validation -->
                                        <div class="validation-actions">
                                            <div class="validation-buttons">
                                                <button type="button" class="btn-validation btn-na {% if validation and validation.niveau_validation == 1 %}active{% endif %}" 
                                                        data-niveau="1" title="Non Acquis">
                                                    <span class="btn-emoji">üü•</span>
                                                    <span class="btn-text">Non Acquis</span>
                                                </button>
                                                
                                                <button type="button" class="btn-validation btn-ec {% if validation and validation.niveau_validation == 2 %}active{% endif %}" 
                                                        data-niveau="2" title="En Cours">
                                                    <span class="btn-emoji">üüß</span>
                                                    <span class="btn-text">En Cours</span>
                                                </button>
                                                
                                                <button type="button" class="btn-validation btn-acquis {% if validation and validation.niveau_validation == 3 %}active{% endif %}" 
                                                        data-niveau="3" title="Acquis">
                                                    <span class="btn-emoji">üü©</span>
                                                    <span class="btn-text">Acquis</span>
                                                </button>
                                                
                                                <button type="button" class="btn-validation btn-expert {% if validation and validation.niveau_validation == 4 %}active{% endif %}" 
                                                        data-niveau="4" title="Expert">
                                                    <span class="btn-emoji">‚úÖ</span>
                                                    <span class="btn-text">Expert</span>
                                                </button>
                                            </div>
                                            
                                            <!-- Commentaire -->
                                            <!--<div class="comment-section">
                                                <label for="commentaire_{{ item.id }}">Commentaire :</label>
                                                <textarea name="commentaire_{{ item.id }}" 
                                                          id="commentaire_{{ item.id }}"
                                                          placeholder="Commentaire pour cet item (optionnel)..."
                                                          class="comment-input">{% if validation %}{{ validation.commentaire }}{% endif %}</textarea>
                                            </div>-->
                                            
                                            <!-- Champ cach√© pour le niveau de validation -->
                                            <input type="hidden" name="niveau_{{ item.id }}" 
                                                   value="{% if validation %}{{ validation.niveau_validation }}{% else %}0{% endif %}">
                                        </div>
                                        
                                        <!-- Commentaire existant affich√© -->
                                        {% if validation and validation.commentaire %}
                                        <div class="existing-comment">
                                            <strong>Commentaire existant :</strong>
                                            <p class="comment-text">{{ validation.commentaire }}</p>
                                        </div>
                                        {% endif %}
                                    </div>
                                </td>
                            </tr>
                        </table>
                    </div>
                    {% endfor %}
                </div>
            </form>
            {% else %}
            <div class="empty-state">
                <i class="fas fa-inbox"></i>
                <p>Aucun item √† valider pour cette √©valuation</p>
            </div>
            {% endif %}
        </div>
    </div>
</div>
{% endblock %}